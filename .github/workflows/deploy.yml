name: Deploy - SSH

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          # Si tu clave tiene passphrase, descomenta la siguiente línea:
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script_stop: true
          script: |
            set -e

            # 1) Preparar carpeta
            mkdir -p /opt/backend-levelup
            cd /opt/backend-levelup

            # 2) Obtener repo (clonar si no existe, actualizar si existe)
            if [ ! -d .git ]; then
              git clone --depth=1 https://github.com/ragallardom/backend_levelup.git .
            else
              git fetch --all
              # ajusta la rama si no es main
              git reset --hard origin/main
            fi

            # 3) Cargar variables sensibles desde .env
            if [ ! -f .env ]; then
              echo "No se encontró /opt/backend-levelup/.env. Crea el archivo antes de ejecutar el despliegue." >&2
              exit 1
            fi

            set -a
            source .env
            set +a

            # 4) Desplegar con docker compose
            # Si necesitas sudo para docker, antepone 'sudo ' a los comandos siguientes
            sudo docker compose down --remove-orphans
            sudo docker compose pull
            sudo docker compose up -d

            # 5) (Opcional) limpiar
            sudo docker system prune -f --volumes || true
