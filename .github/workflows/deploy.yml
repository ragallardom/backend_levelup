name: Deploy - SSH

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      BD_URL: ${{ secrets.BD_URL }}
      BD_USER: ${{ secrets.BD_USER }}
      BD_PASSWORD: ${{ secrets.BD_PASSWORD }}
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          # Si tu clave tiene passphrase, descomenta la siguiente lÃ­nea:
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script_stop: true
          envs: BD_URL,BD_USER,BD_PASSWORD
          script: |
            set -e

            # 1) Preparar carpeta
            mkdir -p /opt/backend-levelup
            cd /opt/backend-levelup

            # 2) Obtener repo (clonar si no existe, actualizar si existe)
            if [ ! -d .git ]; then
              git clone --depth=1 https://github.com/ragallardom/backend_levelup.git .
            else
              git fetch --all
              # ajusta la rama si no es main
              git reset --hard origin/main
            fi

            # 3) Preparar variables sensibles
            if [ -z "${BD_URL}" ] || [ -z "${BD_USER}" ] || [ -z "${BD_PASSWORD}" ]; then
              echo "Faltan variables BD_URL, BD_USER o BD_PASSWORD. Verifica los secretos configurados en el repositorio." >&2
              exit 1
            fi

            cat > .env <<EOF
            BD_URL="${BD_URL}"
            BD_USER="${BD_USER}"
            BD_PASSWORD="${BD_PASSWORD}"
            EOF

            set -a
            source .env
            set +a

            # 4) Desplegar con docker compose
            # Si necesitas sudo para docker, antepone 'sudo ' a los comandos siguientes
            sudo docker compose down --remove-orphans
            sudo docker compose pull
            sudo docker compose up -d

            # 5) (Opcional) limpiar
            sudo docker system prune -f --volumes || true
